<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T2Z WASM Demo - Zcash Transparent to Shielded</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface-2: #1a1a24;
      --border: #2a2a3a;
      --text: #e4e4eb;
      --text-muted: #8888a0;
      --accent: #f4a623;
      --accent-dim: #c4861a;
      --success: #4ade80;
      --error: #f87171;
      --code-bg: #0d0d14;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 300;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }

    h1 span {
      color: var(--accent);
      font-weight: 600;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h2::before {
      content: '▸';
      opacity: 0.5;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .status-item {
      background: var(--surface-2);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .status-item .label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .status-item .value {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .status-item .value.ready { color: var(--success); }
    .status-item .value.pending { color: var(--accent); }
    .status-item .value.error { color: var(--error); }

    button {
      font-family: inherit;
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    button:hover:not(:disabled) {
      background: var(--accent-dim);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    button.secondary:hover:not(:disabled) {
      background: var(--border);
    }

    .log-container {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .log-entry {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry .time {
      color: var(--text-muted);
      font-size: 0.75rem;
      min-width: 80px;
    }

    .log-entry .message {
      flex: 1;
      word-break: break-all;
    }

    .log-entry.info .message { color: var(--text); }
    .log-entry.success .message { color: var(--success); }
    .log-entry.error .message { color: var(--error); }
    .log-entry.warn .message { color: var(--accent); }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .input-group input, .input-group textarea {
      width: 100%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
    }

    .input-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .input-group input:focus, .input-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .warning {
      background: rgba(244, 166, 35, 0.1);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: var(--accent);
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    footer {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span>T2Z</span> WASM Demo</h1>
      <p class="subtitle">Transparent to Shielded Zcash Transactions • Orchard • Halo 2</p>
    </header>

    <div class="card">
      <h2>Module Status</h2>
      <div class="status-grid">
        <div class="status-item">
          <div class="label">WASM Module</div>
          <div class="value" id="wasm-status">Loading...</div>
        </div>
        <div class="status-item">
          <div class="label">Proving Key</div>
          <div class="value" id="pk-status">Not Built</div>
        </div>
        <div class="status-item">
          <div class="label">Version</div>
          <div class="value" id="version">-</div>
        </div>
      </div>
      <button id="btn-build-pk" disabled>Build Proving Key (~10s)</button>
      <button id="btn-check-pk" class="secondary" disabled>Check PK Status</button>
    </div>

    <div class="card">
      <h2>Demo Transaction</h2>
      <div class="warning">
        ⚠️ This demo uses fake test data. Real transactions require valid UTXOs and addresses.
      </div>
      
      <div class="input-group">
        <label>Network</label>
        <select id="input-network" style="width: 100%; background: var(--surface-2); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; color: var(--text); font-family: inherit; font-size: 0.85rem;">
          <option value="mainnet">Mainnet</option>
          <option value="testnet">Testnet</option>
        </select>
      </div>

      <div class="input-group">
        <label>Recipient Address (Unified Address with Orchard receiver)</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="input-address" placeholder="u1... (mainnet) or utest1... (testnet)" value="" style="flex: 1;">
          <button type="button" id="btn-example-addr" class="secondary" style="white-space: nowrap; margin: 0;">Generate</button>
        </div>
        <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
          Click "Example" for a sample address. For real testing, use an address you control.
        </small>
      </div>

      <div class="input-group">
        <label>Amount (zatoshis)</label>
        <input type="number" id="input-amount" value="50000">
      </div>

      <div class="input-group">
        <label>Memo (optional, text)</label>
        <input type="text" id="input-memo" placeholder="Hello from T2Z!" value="Hello from T2Z!">
      </div>

      <button id="btn-propose" disabled>1. Propose Transaction</button>
      <button id="btn-prove" disabled>2. Prove (Halo 2)</button>
      <button id="btn-sign" disabled>3. Sign Input</button>
      <button id="btn-finalize" disabled>4. Finalize & Extract</button>
    </div>

    <div class="card">
      <h2>Execution Log</h2>
      <div class="log-container" id="log">
        <div class="log-entry info">
          <span class="time">--:--:--</span>
          <span class="message">Waiting for WASM module to load...</span>
        </div>
      </div>
    </div>

    <footer>
      <p>
        Built with <a href="https://github.com/nicholasbishop/pczt" target="_blank">PCZT</a> • 
        <a href="https://github.com/d4mr/t2z" target="_blank">T2Z on GitHub</a> •
        ZIP 244, 321, 374 Compliant
      </p>
    </footer>
  </div>

  <script type="module">
    // Import the WASM module from installed package
    // Note: This is bundler target, auto-initializes (no init() needed)
    import * as t2z from '@d4mr/t2z-wasm';

    // State
    let currentPczt = null;
    let isProved = false;
    let isSigned = false;

    // DOM Elements
    const wasmStatus = document.getElementById('wasm-status');
    const pkStatus = document.getElementById('pk-status');
    const versionEl = document.getElementById('version');
    const logContainer = document.getElementById('log');

    const btnBuildPk = document.getElementById('btn-build-pk');
    const btnCheckPk = document.getElementById('btn-check-pk');
    const btnPropose = document.getElementById('btn-propose');
    const btnProve = document.getElementById('btn-prove');
    const btnSign = document.getElementById('btn-sign');
    const btnFinalize = document.getElementById('btn-finalize');

    const inputNetwork = document.getElementById('input-network');
    const inputAddress = document.getElementById('input-address');
    const inputAmount = document.getElementById('input-amount');
    const inputMemo = document.getElementById('input-memo');
    const btnExampleAddr = document.getElementById('btn-example-addr');

    // Fill in a randomly generated test address
    btnExampleAddr.addEventListener('click', () => {
      try {
        const network = inputNetwork.value;
        
        // Check if the generate_test_address function exists (requires updated WASM)
        if (typeof t2z.generate_test_address === 'function') {
          const addr = t2z.generate_test_address(network);
          inputAddress.value = addr;
          log(`Generated random ${network} Orchard address`, 'success');
          log('⚠️ Spending key discarded - cannot receive real funds!', 'warn');
        } else {
          // Fallback: prompt user to enter their own address
          log('Address generation not available - please enter your own address', 'warn');
          log('Update @d4mr/t2z-wasm to latest version for this feature', 'info');
        }
      } catch (error) {
        log(`Failed to generate address: ${error.message}`, 'error');
      }
    });

    // Update placeholder when network changes
    inputNetwork.addEventListener('change', () => {
      const network = inputNetwork.value;
      inputAddress.placeholder = network === 'mainnet' 
        ? 'u1... (mainnet unified address)' 
        : 'utest1... (testnet unified address)';
    });

    // Logging
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<span class="time">${time}</span><span class="message">${message}</span>`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLog() {
      logContainer.innerHTML = '';
    }

    // Helpers
    function textToHex(text) {
      return Array.from(new TextEncoder().encode(text))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    function bytesToHex(bytes) {
      return Array.from(bytes)
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // Valid test data using a known secp256k1 keypair
    // WARNING: This is a well-known test private key - NEVER use in production!
    function generateTestInput() {
      // Private key: 0x01 (the simplest valid private key)
      const secretKey = '0000000000000000000000000000000000000000000000000000000000000001';
      
      // Corresponding compressed public key (G point on secp256k1)
      const pubkey = '0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798';
      
      // pubkey hash = RIPEMD160(SHA256(pubkey)) for P2PKH
      const pubkeyHash = '751e76e8199196d454941c45d1b3a323f1433bd6';
      
      // P2PKH scriptPubKey: OP_DUP OP_HASH160 <20-byte-hash> OP_EQUALVERIFY OP_CHECKSIG
      const scriptPubkey = '76a914' + pubkeyHash + '88ac';
      
      // Fake txid (this won't exist on chain, but format is valid)
      const txid = '0000000000000000000000000000000000000000000000000000000000000001';
      
      return { pubkey, txid, scriptPubkey, secretKey };
    }

    // Initialize
    async function initialize() {
      try {
        log('Initializing WASM module...');
        // Auto-initialized by bundler target, just call init for panic hook
        t2z.init();
        
        wasmStatus.textContent = 'Ready';
        wasmStatus.className = 'value ready';
        versionEl.textContent = t2z.version();
        
        log('✓ WASM module initialized', 'success');
        log(`Version: ${t2z.version()}`);
        
        // Enable buttons
        btnBuildPk.disabled = false;
        btnCheckPk.disabled = false;
        btnPropose.disabled = false;
        
        // Check if PK is already built
        updatePkStatus();
        
      } catch (error) {
        wasmStatus.textContent = 'Error';
        wasmStatus.className = 'value error';
        log(`✗ Failed to initialize: ${error.message}`, 'error');
      }
    }

    function updatePkStatus() {
      const ready = t2z.is_proving_key_ready();
      pkStatus.textContent = ready ? 'Ready' : 'Not Built';
      pkStatus.className = ready ? 'value ready' : 'value pending';
      
      // Enable prove button if we have a PCZT and PK is ready
      btnProve.disabled = !currentPczt || !ready;
    }

    // Event Handlers
    btnBuildPk.addEventListener('click', async () => {
      btnBuildPk.disabled = true;
      btnBuildPk.innerHTML = '<span class="spinner"></span>Building...';
      pkStatus.textContent = 'Building...';
      pkStatus.className = 'value pending';
      
      log('Building Orchard proving key (Halo 2 circuit)...');
      log('This takes ~10 seconds on first run, no downloads needed!', 'warn');
      
      const start = performance.now();
      
      // Use setTimeout to allow UI to update
      setTimeout(() => {
        try {
          t2z.prebuild_proving_key();
          const elapsed = ((performance.now() - start) / 1000).toFixed(2);
          
          log(`✓ Proving key built in ${elapsed}s`, 'success');
          updatePkStatus();
          
        } catch (error) {
          log(`✗ Failed to build proving key: ${error.message}`, 'error');
          pkStatus.textContent = 'Error';
          pkStatus.className = 'value error';
        }
        
        btnBuildPk.disabled = false;
        btnBuildPk.textContent = 'Build Proving Key (~10s)';
      }, 50);
    });

    btnCheckPk.addEventListener('click', () => {
      updatePkStatus();
      log(`Proving key ready: ${t2z.is_proving_key_ready()}`);
    });

    btnPropose.addEventListener('click', () => {
      try {
        const address = inputAddress.value.trim();
        const memoText = inputMemo.value;
        
        if (!address) {
          log('✗ Please enter a recipient address', 'error');
          return;
        }
        
        log('Creating transaction proposal...');
        
        // Generate test input
        const testInput = generateTestInput();
        
        // Store secret key for signing later
        window._testSecretKey = testInput.secretKey;
        
        // Get selected network
        const network = inputNetwork.value;
        
        // Calculate proper ZIP-317 fee
        // 1 transparent input, 0 transparent outputs (no change), 1 Orchard output
        const fee = t2z.calculate_fee(1, 0, 1);
        log(`Fee (ZIP-317): ${fee} zatoshis`);
        
        // Set input value to exactly cover payment + fee (no change needed)
        // This simplifies the demo by avoiding the need for a change address
        const amount = BigInt(inputAmount.value);
        const inputValue = amount + fee;
        
        log(`Input: ${inputValue} zatoshis from fake UTXO`);
        log(`Output: ${amount} zatoshis to ${address.slice(0, 20)}...`);
        log(`Change: 0 zatoshis (exact amount)`);
        
        // Create input with exact value needed
        const input = new t2z.WasmTransparentInput(
          testInput.pubkey,
          testInput.txid,
          0,        // prevout_index
          inputValue,
          testInput.scriptPubkey,
          null      // sequence (use default)
        );
        
        // Create payment
        const memoHex = memoText ? textToHex(memoText) : null;
        const payment = new t2z.WasmPayment(
          address,
          amount,
          memoHex,
          null      // label
        );
        
        // Propose transaction - no change address needed since input = output + fee
        currentPczt = t2z.propose_transaction(
          [input],
          [payment],
          fee,      // ZIP-317 calculated fee
          null,     // no change address (exact amount)
          network,
          2500000   // expiry_height
        );
        
        log(`Network: ${network}`);
        
        isProved = false;
        isSigned = false;
        
        log(`✓ Transaction proposed!`, 'success');
        log(`PCZT size: ${currentPczt.to_bytes().length} bytes`);
        
        // Update button states
        updatePkStatus();
        btnSign.disabled = true;
        btnFinalize.disabled = true;
        
      } catch (error) {
        log(`✗ Proposal failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    btnProve.addEventListener('click', () => {
      if (!currentPczt) {
        log('✗ No transaction to prove', 'error');
        return;
      }
      
      btnProve.disabled = true;
      btnProve.innerHTML = '<span class="spinner"></span>Proving...';
      
      log('Creating Orchard proof...');
      const start = performance.now();
      
      setTimeout(() => {
        try {
          currentPczt = t2z.prove_transaction(currentPczt);
          const elapsed = ((performance.now() - start) / 1000).toFixed(2);
          
          isProved = true;
          log(`✓ Transaction proved in ${elapsed}s`, 'success');
          
          btnSign.disabled = false;
          
        } catch (error) {
          log(`✗ Proving failed: ${error.message}`, 'error');
          console.error(error);
        }
        
        btnProve.disabled = false;
        btnProve.textContent = '2. Prove (Halo 2)';
        updatePkStatus();
      }, 50);
    });

    btnSign.addEventListener('click', () => {
      if (!currentPczt) {
        log('✗ No transaction to sign', 'error');
        return;
      }
      
      try {
        log('Signing transparent input...');
        
        // Use the test secret key from proposal
        const secretKey = window._testSecretKey;
        if (!secretKey) {
          log('✗ No secret key available - propose a transaction first', 'error');
          return;
        }
        
        currentPczt = t2z.sign_transparent_input(currentPczt, 0, secretKey);
        
        isSigned = true;
        log('✓ Input signed', 'success');
        
        btnFinalize.disabled = false;
        
      } catch (error) {
        log(`✗ Signing failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    btnFinalize.addEventListener('click', () => {
      if (!currentPczt) {
        log('✗ No transaction to finalize', 'error');
        return;
      }
      
      try {
        log('Finalizing transaction...');
        
        const txBytes = t2z.finalize_and_extract(currentPczt);
        const txHex = bytesToHex(txBytes);
        
        log('✓ Transaction finalized!', 'success');
        log(`Transaction size: ${txBytes.length} bytes`);
        log(`Hex (first 100 chars): ${txHex.slice(0, 100)}...`);
        
        // In a real app, you'd broadcast this to the network
        log('Ready to broadcast to Zcash network!', 'warn');
        
      } catch (error) {
        log(`✗ Finalization failed: ${error.message}`, 'error');
        console.error(error);
      }
    });

    // Start
    initialize();
  </script>
</body>
</html>

